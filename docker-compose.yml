version: '3.7'
services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda-iot
    command:
      - redpanda start
      - --smp 1  # Limite l'usage CPU (1 coeur), idéal pour l'IoT/Edge
      - --memory 1G # Limite RAM, ajustable selon votre hardware
      - --overprovisioned
      - --kafka-addr internal://0.0.0.0:19092,external://0.0.0.0:9092
      - --advertise-kafka-addr internal://redpanda:19092,external://localhost:9092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --set redpanda.auto_create_topics_enabled=true
      - --set redpanda.default_topic_replications=1
      - --set redpanda.default_topic_partitions=1
    ports:
      - 18081:18081 # Schema Registry
      - 18082:18082 # API HTTP Proxy
      - 9092:9092   # Kafka API (Accès externe/localhost)
      - 9644:9644   # Admin API
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy|OK'"]
      interval: 10s
      timeout: 5s
      retries: 5

  console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    entrypoint: /bin/sh
    command: -c "echo \"$$CONSOLE_CONFIG_FILE\" > /tmp/config.yaml; /app/console"
    environment:
      CONFIG_FILEPATH: /tmp/config.yaml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:19092"]
        schemaRegistry:
          enabled: true
          urls: ["http://redpanda:8081"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    ports:
      - 8080:8080
    depends_on:
      - redpanda

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/logs:/mosquitto/logs

  replayer:
      build: ./data-replay
      container_name: data-replay
      depends_on:
        - mosquitto
        - redpanda
      environment:
        - BROKER_ADDRESS=mosquitto
        - BROKER_PORT=1883
        - PATIENT_USER_NAME=caroni
      restart: on-failure
  
  edge_iot_agent:
      build: ./edge-iot-agent
      container_name: edge-iot-agent
      depends_on:
        - mosquitto
        - redpanda
      environment:
        - BROKER_ADDRESS=mosquitto
        - BROKER_PORT=1883
        - RP_BROKER=redpanda:19092
        - PATIENT_USER_NAME=caroni
      restart: on-failure
  
  edge_ai_agent:
      build: ./edge-AI
      container_name: edge-ai-agent
      depends_on:
        - redpanda
      environment:
        - RP_BROKER=redpanda:19092
      restart: on-failure

  edge_cloud_sender:
      build: ./edge-cloud-sender
      container_name: edge-cloud-sender
      depends_on:
        - redpanda
      environment:
        - RP_BROKER=redpanda:19092
      restart: on-failure

  mongo:
    image: mongo:4.4
    container_name: fiware-mongo
    restart: unless-stopped
    command: ["--bind_ip_all"]
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongo", "--quiet", "mongodb://localhost:27017/admin", "--eval", "db.runCommand({ ping: 1 }).ok"]
      interval: 10s
      timeout: 5s
      retries: 10

  orion-ld:
    image: fiware/orion-ld:latest
    container_name: fiware-orion-ld
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "1026:1026"
    command: >
      -dbhost mongo
      -logLevel INFO
      -forwarding
      -reqPoolSize 10
    healthcheck:
      test: ["CMD-SHELL", "sh -ec '>/dev/tcp/127.0.0.1/1026'"]
      interval: 5s
      timeout: 3s
      retries: 60
    environment:
      FIWARE_SERVICE: "per-sla"
      FIWARE_SERVICEPATH: "/"

  pepper:
    image: fiware/pep-proxy:8.4.0
    container_name: fiware-pepper
    restart: unless-stopped
    depends_on:
      wait-orion:
        condition: service_started
    ports:
      - "8082:80"
    environment:
      PEPPER_BROKER_URL: "http://localhost:1026"

  mongo-express:
    image: mongo-express:1.0.2
    container_name: fiware-mongo-express
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: "mongodb://mongo:27017"
      ME_CONFIG_BASICAUTH: "false"

  ngsi-api:
    image: node:20-alpine
    container_name: fiware-ngsi-api
    restart: unless-stopped
    depends_on:
      wait-orion:
        condition: service_started
    working_dir: /app
    volumes:
      - ./services/ngsi-api:/app
    environment:
      PORT: "3000"
      ORION_LD_BASE_URL: "http://orion-ld:1026"
      OWNER_ATTR: "ownerId"
      TIME_ATTR: "observedAt"
      ORION_TIMEOUT_MS: "10000"
    command: ["sh", "-c", "npm install && npm run start"]
    ports:
      - "3000:3000"

  wait-orion:
    image: node:20-alpine
    container_name: fiware-wait-orion
    depends_on:
      orion-ld:
        condition: service_started
    environment:
      ORION_LD_BASE_URL: "http://orion-ld:1026"
    command:
      [
        "sh","-ec",
        "node -e \"const u=process.env.ORION_LD_BASE_URL+'/version';const http=require('http');const https=require('https');const lib=u.startsWith('https')?https:http;let n=0;const tick=()=>{const req=lib.get(u,r=>{if(r.statusCode&&r.statusCode<500){process.exit(0)}else{fail()}});req.on('error',fail);req.setTimeout(2000,()=>{req.destroy(new Error('timeout'))});};const fail=()=>{n++; if(n>120){console.error('Orion not ready'); process.exit(1)}; setTimeout(tick,1000)};tick();\""
      ]

  grafana:
    image: grafana/grafana:11.5.2
    container_name: per-sla-grafana
    restart: unless-stopped
    depends_on:
      ngsi-api:
        condition: service_started
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: "admin"
      GF_SECURITY_ADMIN_PASSWORD: "admin"
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
      GF_INSTALL_PLUGINS: "yesoreyeram-infinity-datasource" # Essaie de fixer la version
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
  
  cratedb:
    image: crate:5.4
    container_name: fiware-cratedb
    restart: unless-stopped
    ports:
      - "4200:4200"
      - "4300:4300"
      - "5432:5432"
    command: crate -Ccluster.name=democluster -Chttp.cors.enabled=true -Chttp.cors.allow-origin="*"
    volumes:
      - cratedb-data:/data

  quantumleap:
    image: orchestracities/quantumleap:latest
    container_name: fiware-quantumleap
    restart: unless-stopped
    ports:
      - "8668:8668"
    depends_on:
      - cratedb
      - orion-ld
    environment:
      - CRATE_HOST=cratedb
      - USE_GEOCODING=false # Mettre à true si vous gérez des coordonnées GPS complexes
      - LOGLEVEL=INFO

  setup-subscriptions:
    image: curlimages/curl:latest
    container_name: fiware-setup-subscriptions
    restart: "no" # Ne s'exécute qu'une seule fois au démarrage
    depends_on:
      wait-orion:
        condition: service_completed_successfully
    command: >
      -s -X POST http://orion-ld:1026/ngsi-ld/v1/subscriptions/
      -H 'Content-Type: application/json'
      -d '{
        "description": "Notify QuantumLeap of all entity changes",
        "type": "Subscription",
        "entities": [{"type": "HealthRawInformation"}],
        "notification": {
          "endpoint": {
            "uri": "http://quantumleap:8668/v2/notify",
            "accept": "application/json"
          }
        }
      }'

volumes:
  redpanda-data:
  mongo-data:
  grafana-data:
  cratedb-data:
